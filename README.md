# RAG评估与改进系统

这是一个为科研人员设计的RAG（检索增强生成）评估与改进的可视化分析系统。该系统帮助用户定位RAG问题所在，并通过多维度的可视化分析提供改进建议。

## 系统功能

系统遵循"理解问题—定位问题—解决问题—验证结果"的工作流程，提供全面的RAG分析与优化工具。

### 问题概览
- **多维问题可视化**：通过热力图展示文档块分布，力导向图分析问题类型
- **问题分析**：力导向图从检索失效、Prompt脆弱性、生成异常、标准异常四个维度分析问题
- **问题类型分布**：展示不同类型问题的统计分布
- **查询视图**：显示选中问题的详细信息，包括问题文本、参考答案和维度分析

### 诊断分析
- **文档块分析**：展示相关文档块排名及重要性评分，帮助用户理解检索结果质量
- **答案溯源**：追踪生成答案的来源，显示置信度和关键实体，清晰标记不确定内容
- **错误定位**：帮助找出RAG流程中的具体问题环节

### 改进验证
- **指标对比**：展示改进前后的性能指标对比
- **多维分析**：包括PCA分析、指标分布和雷达图等多种可视化方式

## 目录结构

```
rag-helper/
├── src/                     # 源代码
│   ├── assets/              # 静态资源（CSS等）
│   ├── components/          # 组件目录
│   │   ├── common/          # 通用组件
│   │   ├── diagnostic/      # 诊断分析组件
│   │   │   ├── AnswerTracing.vue    # 答案追踪组件（整合子组件）
│   │   │   ├── PromptBuilder.vue    # 提示词构建组件
│   │   │   ├── AnswerViewer.vue     # 答案展示组件
│   │   │   ├── EvidenceTracker.vue  # 证据追踪组件
│   │   │   ├── ChunkRanking.vue     # 文档块排名组件
│   │   │   └── DiagnosticPanel.vue  # 诊断面板
│   │   ├── overview/        # 问题概览组件
│   │   │   ├── ForceDiagramChart.vue  # 力导向图（四维问题分析）
│   │   │   ├── HeatmapChart.vue       # 热力图（文档块分布）
│   │   │   ├── TypeDistributionChart.vue  # 问题类型分布图
│   │   │   ├── QueryView.vue            # 问题详情视图
│   │   │   ├── FilterView.vue           # 过滤器视图
│   │   │   └── VisualizationPlaceholder.vue  # 可视化占位
│   │   ├── validation/      # 验证结果组件
│   │   └── UnifiedPanel.vue # 统一面板组件（主界面）
│   ├── data/                # 数据处理
│   ├── layouts/             # 布局组件
│   ├── services/            # 服务层
│   │   └── answerService.ts # 答案服务
│   ├── statics/             # 静态数据文件
│   │   ├── chunk_res.json         # 文档块数据
│   │   ├── force_diagram_data.json  # 力导向图测试数据
│   │   ├── result8.json            # 问题数据
│   │   ├── sample_answer.json      # 示例答案数据
│   │   └── embeddings_2d.json      # 向量嵌入数据
│   ├── store/               # 状态管理
│   │   ├── questionStore.js  # 问题状态管理
│   │   ├── chunkStore.js     # 文档块状态管理
│   │   └── store.js          # Pinia存储配置
│   ├── types/               # 类型定义
│   │   └── answer.ts        # 答案数据类型定义
│   ├── utils/               # 工具函数
│   │   └── textMarkUtils.ts # 文本标记工具函数
│   ├── App.vue              # 根组件
│   └── main.js              # 入口文件
├── index.html               # HTML入口
├── package.json             # 项目配置
└── vite.config.js           # Vite配置
```

## 核心功能详解

### 1. 力导向图 (ForceDiagramChart.vue)
- 展示四个关键维度的问题分析：检索失效、Prompt脆弱性、生成异常和标准异常
- 通过四个角落的三角形表示不同维度的力
- 数据点根据四个维度的力值被拉向不同方向
- 点击数据点显示详细问题信息
- 自适应布局，保持正方形显示比例
- 优化的容错机制，确保即使数据加载失败也能正常显示

### 2. 热力图 (HeatmapChart.vue)
- 展示文档块在二维空间中的分布
- 密度调节滑块：通过滑块控制显示密度，调整0-100%的文档块
- 减小的点大小和优化的边距设置，提高显示效率
- 支持缩放和平移操作

### 3. 查询视图 (QueryView.vue)
- 显示选中问题的完整信息
- 展示问题文本和参考答案
- 提供四个维度的力量分析指标
- 增强的UI样式，与整体设计保持一致

### 4. 答案追踪模块
- **AnswerTracing.vue**：整合答案追踪相关功能的父组件
- **PromptBuilder.vue**：提示词构建功能，允许用户自定义提示词并集成文档块
- **AnswerViewer.vue**：展示生成的答案，包括置信度、命名实体和证据支持
  - 支持标记高亮显示（命名实体、证据、不确定内容）
  - 动态渲染带标记的HTML内容
  - 提供复制功能和加载状态
- **EvidenceTracker.vue**：提供证据追踪功能，显示答案来源和相关文档块
  - 根据相关性显示不同色彩的边框
  - 展示每个证据的来源和内容

### 5. 后端数据结构
系统使用以下数据结构进行前后端交互：

- **AnswerData**：包含生成的答案信息
  - `text`: 原始答案文本
  - `marks`: 文本标记列表
  - `model`: 使用的模型名称
  - `confidence`: 置信度分数(0-1)
  - `evidences`: 支持证据列表
  - `timestamp`: 生成时间戳

- **TextMark**：文本标记信息
  - `type`: 标记类型 (entity/evidence/uncertain)
  - `startIndex`: 开始位置
  - `endIndex`: 结束位置
  - `text`: 被标记的文本内容
  - `sourceId`: 关联的证据ID (对evidence类型)

- **Evidence**：证据项信息
  - `id`: 证据ID
  - `source`: 证据来源
  - `text`: 证据文本内容
  - `relevance`: 相关性分数(0-1)

## 技术栈

- **前端框架**：Vue 3 (使用Composition API与script setup语法)
- **状态管理**：Pinia
- **可视化库**：D3.js, ECharts
- **构建工具**：Vite
- **样式**：CSS原生变量

## 安装与运行

```bash
# 安装依赖
npm install

# 开发模式运行
npm run dev

# 构建生产版
npm run build
```

## 使用流程

1. 选择要分析的问题
2. 查看问题概览区域，了解文档分布和问题类型
3. 使用诊断分析区域定位具体问题
4. 应用改进建议
5. 在验证结果区域比较改进前后的效果

## 最近更新

### 2024年3月更新
- **后端集成改进**：
  - 设计标准化的后端数据结构，实现前后端一致的数据交互
  - 添加文本标记系统，支持自动识别和高亮显示命名实体、证据支持和不确定内容
  - 实现文本索引定位系统，准确标记不同类型的内容片段
  - 优化证据追踪功能，支持按相关性显示不同视觉效果

- **组件重构**：
  - 将AnswerTracing.vue拆分为三个独立组件：PromptBuilder.vue、AnswerViewer.vue和EvidenceTracker.vue
  - 优化组件间通信，使用事件传递和refs引用
  - 改进组件复用性和可维护性

- **Prompt构建功能**：
  - 在答案溯源视图中添加Prompt构建工具，支持用户自定义提示词
  - 可视化文档块集成系统，允许用户通过标签形式管理检索到的文档块
  - 支持从"标准参考"中添加或移除文档块，动态构建最优提示词
  - 文档块以不同颜色标签展示，直观反映相关性等级
  - 生成按钮一键构建最终提示词，自动整合所选文档块内容

### 2023年12月更新
- 添加查询视图组件，展示问题详情
- 力导向图组件优化：
  - 增强容错性和鲁棒性
  - 确保正方形布局和居中显示
  - 优化三角形标记大小和交互性
- 热力图组件改进：
  - 添加密度控制滑块
  - 优化文档块显示效率
  - 减小边距，增加有效显示区域
- UI布局优化：
  - 统一各组件间的对齐方式
  - 调整标题和内容区域样式
  - 确保统一的视觉风格

## 开发贡献

该项目使用模块化的组件设计，每个功能区域都有独立的组件。开发新功能时，建议遵循现有的设计模式和样式指南。 